





<!DOCTYPE html>
<html lang="en">
    <!--
                                   _
                                ==(W{==========-      /===-
                                  ||  (.--.)         /===-_---~~~~~~~~~------____
                                  | \_,|**|,__      |===-~___                _,-' `
                     -==\\        `\ ' `--'   ),    `//~\\   ~~~~`---.___.-~~
                 ______-==|        /`\_. .__/\ \    | |  \\           _-~`
           __--~~~  ,-/-==\\      (   | .  |~~~~|   | |   `\        ,'
        _-~       /'    |  \\     )__/==0==-\<>/   / /      \      /
      .'        /       |   \\      /~\___/~~\/  /' /        \   /'
    /  ____  /         |    \`\.__/-~~   \  |_/'  /          \/'
    /-'~    ~~~~~---__  |     ~-/~         ( )   /'        _--~`
                      \_|      /        _) | ;  ),   __--~~
                        '~~--_/      _-~/- |/ \   '-~ \
                       {\__--_/}    / \\_>-|)<__\      \
                       /'   (_/  _-~  | |__>--<__|      |
                      |   _/) )-~     | |__>--<__|      |
                      / /~ ,_/       / /__>---<__/      |
                     o-o _//        /-~_>---<__-~      /
                     (^(~          /~_>---<__-      _-~
                    ,/|           /__>--<__/     _-~
                 ,//('(          |__>--<__|     /                  .----_
                ( ( '))          |__>--<__|    |                 /' _---_~\
             `-)) )) (           |__>--<__|    |               /'  /     ~\`\
            ,/,'//( (             \__>--<__\    \             /'  //        ||
          ,( ( ((, ))              ~-__>--<_~-_  ~--____---~' _/'/        /'
        `~/  )` ) ,/|                 ~-_~>--<_/-__       __-~ _/
      ._-~//( )/ )) `                    ~~-'_/_/ /~~~~~~~__--~
       ;'( ')/ ,)(                              ~~~~~~~~~~
     ' ') '( (/
        '   '  `

    Handcrafted by
       ___         __
      / _ \ ___   / /
     / , _// _ \ / _ \
    /_/|_| \___//_.__/
       __  ___      _____       _                 ___         __
      /  |/  /____ / ___/__ __ (_)____ ___  ____ / _ \ ___ _ / /___
     / /|_/ // __// (_ // // // // __// -_)/___// // // _ `// // -_)
    /_/  /_/ \__/ \___/ \_,_//_//_/   \__/     /____/ \_,_//_/ \__/

         Providing a tiny dent in the fabric of spacetime since 1986
    -->

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>Versioned database backups with Git &raquo; Rob McGuire-Dale</title>

        <!-- CSS -->
        <link href="/css/prettify-r187.min.css" type="text/css"
                rel="stylesheet" />

        <link href='/css/bootstrap-2.1.1.min.css' type='text/css'
                rel="stylesheet" />
        <link href='/css/bootstrap-responsive-2.1.1.min.css' type='text/css'
                rel="stylesheet"/>
        <link href='/less/base.css' type='text/css' rel="stylesheet"/>

        
        
    <link href='/less/blog.css' type='text/css' rel="stylesheet"/>


        
        
    </head>

    <body>
        <!-- Navbar -->
        <div id='navbar' class='navbar navbar-fixed-top'>
            <div class="navbar-inner">
                <div class="container">

                    <a class='brand' href='/'>
                        <div class='hidden-phone'>Rob McGuire-Dale</div>
                        <div id='short-name' class='visible-phone'>
                            Rob M.D.
                        </div>
                    </a>

                    <div id='nav-links'>
                        <ul class='nav pull-right'>
                            <li>
                                <a id='home' href='/'>
                                    home
                                </a>
                            </li>
                            <li>
                                <a id='blog' href='/blog/'>
                                    blog
                                </a>
                            </li>
                            <li>
                                <a id='resume' href='/resume/'>
                                    r&eacute;sum&eacute;
                                </a>
                            </li>
                            <li>
                                <a id='contact' href='/contact/'>
                                    contact
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div id='content' class='container'>
            
<div id='blog-base'>
    <div class='row'>

        <!-- Blog filtering -->
        <div class='span3 hidden-phone'>
            <ul id='filter-list' class='nav nav-list'>

                <!-- Tags -->
                <li class='nav-header'>
                    Tags
                </li>

                
                    <li class='filter-link' tag='database'>
                            <a href='/blog/#database'
            class='tag-link '
            tag='database'>
        
            database (1)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='git'>
                            <a href='/blog/#git'
            class='tag-link '
            tag='git'>
        
            git (1)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='how-to'>
                            <a href='/blog/#how-to'
            class='tag-link '
            tag='how-to'>
        
            how-to (2)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='linux'>
                            <a href='/blog/#linux'
            class='tag-link '
            tag='linux'>
        
            linux (3)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='meta'>
                            <a href='/blog/#meta'
            class='tag-link '
            tag='meta'>
        
            meta (3)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='netsec'>
                            <a href='/blog/#netsec'
            class='tag-link '
            tag='netsec'>
        
            netsec (1)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='programming'>
                            <a href='/blog/#programming'
            class='tag-link '
            tag='programming'>
        
            programming (1)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='software'>
                            <a href='/blog/#software'
            class='tag-link '
            tag='software'>
        
            software (1)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='sysadmin'>
                            <a href='/blog/#sysadmin'
            class='tag-link '
            tag='sysadmin'>
        
            sysadmin (1)
        
    </a>
                    </li>
                
                    <li class='filter-link' tag='windows'>
                            <a href='/blog/#windows'
            class='tag-link '
            tag='windows'>
        
            windows (1)
        
    </a>
                    </li>
                

                <li class="divider"></li>

                <!-- Recent posts -->
                <div id='recent-posts'>
                    <li class='nav-header'>
                        Recent posts
                    </li>

                    
                        <li>
                            <a href='/blog/database-backup-with-git.html'>
                                Versioned database backups with Git
                            </a>
                        </li>
                    
                        <li>
                            <a href='/blog/js-tag-filtering.html'>
                                JavaScript-based tag filtering
                            </a>
                        </li>
                    
                        <li>
                            <a href='/blog/tunneling-with-putty.html'>
                                Tunneling with PuTTY
                            </a>
                        </li>
                    
                        <li>
                            <a href='/blog/blag.html'>
                                Blag
                            </a>
                        </li>
                    
                        <li>
                            <a href='/blog/new-site-powered-by-wok.html'>
                                New website, powered by wok
                            </a>
                        </li>
                    
                        <li>
                            <a href='/blog/xmonad+gnome-in-ubuntu.html'>
                                Xmonad + GNOME in Ubuntu
                            </a>
                        </li>
                    
                        <li>
                            <a href='/blog/nvidia-cuda-in-ubuntu.html'>
                                nVidia CUDA multi-core development in Ubuntu
                            </a>
                        </li>
                    
                </div>
            </ul>
        </div>

        <!-- Blog content -->
        <div id='blog-content' class='span9'>
            <div id='filter-status' class='text-info well'>
                <strong>
                    Viewing articles tagged with
                    "<span class='tag-label'></span>"
                </strong>
                <a href='#' class='clear-filter btn btn-mini pull-right'>View all</a>
            </div>

            
<div id='blog-article'>

    <div id='title-bar'>
        <h2 id='blog-back'>
            <a href='/blog'>
                &laquo; Blog
            </a>
        </h2>
        <h1 id='title'>
            <a href='/blog/database-backup-with-git.html'>
                Versioned database backups with Git
            </a>
        </h1>

        <div id='subtitle' class='muted'>
            
            2012-11-10

            
                | in 
        
            <a href='/blog/#sysadmin'
            class='tag-link '
            tag='sysadmin'>
        
            sysadmin
        
    </a>,
        
    
        
            <a href='/blog/#database'
            class='tag-link '
            tag='database'>
        
            database
        
    </a>,
        
    
        
            and <a href='/blog/#git'
            class='tag-link '
            tag='git'>
        
            git
        
    </a>
        
    
            
        </div>
    </div>

    
        <hr>
    

    <div id='article-body'>
        <p>I'm new to system/database adminstration. I'm currently running a web
application that recieves around ~55,000 hits/day, and whose database grows by
about 60 MiB of plain-text per day.</p>
<p>I came up with a simple, intuitive database backup solution using Git to track
revisions. (And I <a href="http://viget.com/extend/backup-your-database-in-git">wasn't the first</a>.) If you've got a
small- to medium-sized database, this may work for you too.</p>
<h2>Hand-versioning: really inefficient</h2>
<p>Backing up your database is important, but one must also consider keeping
<em>revisions</em> of those backups, since if you keep only the latest backup, but you
risk overwriting a good backup with bad ones.</p>
<div class="highlight"><pre><span class="n">bad</span><span class="o">-</span><span class="nb">dump</span><span class="o">.</span><span class="n">sql</span> <span class="o">-&gt;</span> <span class="n">good</span><span class="o">-</span><span class="nb">dump</span><span class="o">-</span><span class="n">from</span><span class="o">-</span><span class="n">yesterday</span><span class="o">.</span><span class="n">sql</span>
</pre></div>


<p>You might consider writing each backup to its own file, but that means each
backup will consume the entire size of the database each backup, in my case,
~10 GiB per day.</p>
<div class="highlight"><pre><span class="n">dump1</span><span class="o">.</span><span class="n">sql</span>   <span class="mi">10</span> <span class="n">GiB</span>
<span class="n">dump2</span><span class="o">.</span><span class="n">sql</span>   <span class="mi">10</span> <span class="n">GiB</span>
<span class="n">dump3</span><span class="o">.</span><span class="n">sql</span>   <span class="mi">10</span> <span class="n">GiB</span>
</pre></div>


<p>If most of the data in your database is static, that's a lot of wasted space.x</p>
<h2>Enter: Git</h2>
<p><a href="http://en.wikipedia.org/wiki/Git_(software)">Git</a> is a revision control system used primarily in software development to
track changes in source code over time. A database backup, a.k.a a <a href="http://en.wikipedia.org/wiki/Database_dump">database
dump</a>, is just a bunch of SQL statements in a text file, so why not
use Git to track changes in your database backups as well?</p>
<p>The backup process is simple: Dump your database over the previous backup, and
commit. Here's an example backup script using MySQL:</p>
<pre class='prettyprint'>
#! /bin/sh

# Settings
BACKUP_DIR="/path/to/your/backup/directory"
DB_USER="[your database user]"
DB_PASS="[your database user's password]"
DB="[database name]"
DB_DUMP="$BACKUP_DIR/$DB.sql"

# Create your backup directory if it doesn't exist
mkdir -p $BACKUP_DIR

# Dump the database
mysqldump -u $DB_USER -p$DB_PASS --skip-extended-insert $DB &gt; $DB_DUMP

# Change to the backup directory and initialize a new Git repo if necessary
cd $BACKUP_DIR
git init

# Add the database to the repo and commit
git add $DB_DUMP
git commit -m "Update database dump"
</pre>

<p>A couple things to note about this script:</p>
<ul>
<li><code>--skip-extended-insert</code> makes mysqldump create an insert statement on a new
  line for each row. This means a larger initial commit, but all future commits
  will be smaller due to the fact that Git tracks <em>line</em> changes.</li>
<li>Running <code>git init</code> on an existing repository is safe, and will not overwrite
  things that are already there.</li>
</ul>
<p>Now, just throw this script in <code>/etc/cron.daily/</code> for instant, daily versioned
database backup.</p>
<h2>Now what?</h2>
<p>Anything you can do with a normal Git repository, including:</p>
<ul>
<li>Push to a remote repository on a <strong>backup server</strong></li>
<li>Pull the latest database changes to your <strong>development server</strong></li>
<li><strong>View changes</strong> to your database with <code>git whatchanged</code></li>
</ul>
<h2>Optimizations</h2>
<p>As <a href="http://viget.com/extend/backup-your-database-in-git#comment-400539436">suggested</a>
by Bram Schoenmakers, here are some Git configurations that should decrease
disk usage of the repository:</p>
<blockquote>
<ul>
<li><strong>core.compression = 9</strong> - Flag for gzip to specify the compression level for
  blobs and packs. Level 1 is fast with larger file sizes, level 9 takes more
  time but results in better compression.</li>
<li><strong>repack.usedeltabaseoffset = true</strong> - Defaults to <em>false</em> for compatibility
  reasons, but is supported with Git &gt;=1.4.4.</li>
<li><strong>pack.windowMemory = 100m</strong> - (Re)packing objects may consume lots of
  memory. To prevent all your resources [from going] down the drain it's useful
  to put some limits on that. There is also <em>pack.deltaCacheSize</em>.</li>
<li><strong>pack.window = 15</strong> - Defaults to <em>10</em>. With a higher value, Git tries
  harder to find similar blobs.</li>
<li><strong>gc.auto = 1000</strong> - Defaults to <em>6700</em>. As indicated in
  <a href="http://viget.com/extend/backup-your-database-in-git">the article</a>, it is recommended to run <code>git gc</code> every once in a
  while. Personally, I run <code>git gc --auto everyday</code>, so [it] only packs things
  when there's enough garbage. <code>git gc --auto</code> normally only triggers the
  packing mechanism when there are 6700 loose objects around. This flag lowers
  this amount.</li>
<li><strong>gc.autopacklimit 10</strong> - Defaults to <em>50</em>. Every time you run <code>git gc</code>, a
  new pack is generated [of] the loose objects. Over time you get too many
  packs which wastes space. It is a good idea to combine all packs once in a
  while into a single pack, so all objects can be combined and deltified. By
  default <code>git gc</code> does this when there are 50 packs around. But for this
  situation a lower number may be better.</li>
</ul>
</blockquote>
<h2>References</h2>
<ul>
<li><a href="http://viget.com/extend/backup-your-database-in-git">"Backup your Database in Git"</a>
   by David Eisinger</li>
<li><a href="http://linux.die.net/man/1/git-init">git-init man page</a></li>
</ul>
    </div>

    <div id='article-footer'>
        <a href='/blog'>&laquo; Back to blog list</a>
    </div>

    <!-- Disquis comment system -->
    <hr>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        // Disqus config
        var disqus_shortname = 'robmd';

        // Disqus init
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] ||
                document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>
        Please enable JavaScript to view the
        <a href="http://disqus.com/?ref_noscript">comments powered by Disqus
        </a>.
    </noscript> <!--/disquis -->
</div>

        </div>


    </div>
</div>

        </div>

        <!-- Footer -->
        <footer>
            <div class='container muted'>
                <p class='pull-right hidden-phone'>
                    <a href='#'>Back to top</a>
                </p>
                <div class='visible-phone'>
                    <p>
                        <a href='#' class='btn'>Back to top</a>
                    </p>
                    <br>
                </div>
                <p>
                    Last generated at
                    2012/11/28 17:06:14 by
                    <a href="https://github.com/mythmon/wok">Wok</a>.
                </p>
                <p>
                    Site source code availible on
                    <a href="http://github.com/robatron/robmd.net">GitHub</a>.
                </p>
                <p>
                    &copy; Copyright
                    <a href="http://robmd.net/">Rob McGuire-Dale</a>.
                </p>
            </div>
        </footer>

        <!-- JavaScript -->
        <script src="https://www.google.com/jsapi"></script>
        <script src="/js/lib/prettify-r187.min.js"></script>
        <script src="/js/lib/prettify-lang-hs-r187.min.js"></script>
        <script src='/js/lib/less-1.3.0.min.js'></script>
        <script src="/js/lib/jquery-1.8.2.min.js"></script>
        <script src='/js/lib/bootstrap-2.1.1.min.js'></script>
        <script>
            function highlight_syntax(){
                /* Highlight syntax with Google Prettify, and excape any HTML
                classed with 'lang-html'
                */

                // Escape HTML in code tagged as HTML
                $('.lang-html').text($('.lang-html').html())

                // Execute prettyprint
                prettyPrint()
            }

            function menu_highlight(menu_id){
                /* Highlight specified menu item
                */
                $('#navbar .nav li a#'+menu_id).parent('li')
                        .attr('class', 'active')
            }

            function track(){
                /* Google Analytics tracking code. Official docs recommend
                placing at the bottom of </head>, but practice calls for
                placing the JS at the bottom of the body to speed up appearance
                of page load for users.
                */
                var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-17987944-2']);
                _gaq.push(['_setDomainName', 'robmd.net']);
                _gaq.push(['_trackPageview']);
                (function() {
                    var ga = document.createElement('script');
                    ga.type = 'text/javascript'; ga.async = true;
                    ga.src = ('https:' == document.location.protocol ?
                            'https://ssl' :
                            'http://www') + '.google-analytics.com/ga.js';
                    var s = document.getElementsByTagName('script')[0];
                    s.parentNode.insertBefore(ga, s);
                })();
            }

            // Init
            // ====
            function init(){
                /* Initialize the JavaScript for RobMD.net
                */
                var local = window.location.hostname === 'localhost'
                if(!local) track()
            }

            // "Main"
            // ======
            init()

            // Subpage init --
            

    // Tag filtering
    // -------------

    function filter_by_tag(tag){
        /* Remove all blog posts that aren't tagged with `tag`, show all that
        are. Ignore blank tag names.
        */

        if(tag){
            $('.blog-post').each(function(index){
                var tags = $(this).attr('tags').split(' ')
                var has_tag = false

                for(var i in tags){
                    if(tags[i] === tag){
                        has_tag = true
                        break
                    }
                }

                if(has_tag) {
                    $(this).slideDown("slow")
                } else {
                    $(this).slideUp("slow")
                }
            });
        }

        activate_filter_link(tag)
        show_filter_status(tag)
    }

    function show_all(){
        /* Show all blog articles
        */

        $('.blog-post').slideDown('slow')
    }

    // Tag link de/activate
    // --------------------

    function activate_filter_link(tag){
        /* Radio-activate the specified tag link's list-item
        */
        var $link = $('#filter-list .filter-link[tag="' + tag + '"]')
        deactivate_all_filter_links()
        $link.addClass('active')
    }

    function deactivate_all_filter_links(){
        /* Deactivate all tag links' list items
        */
        $('#filter-list li').removeClass('active')
    }

    // Filter status box
    // -----------------

    function show_filter_status(tag){
        $('#filter-status').slideDown()
        $('#filter-status .tag-label').text(tag)
    }

    function hide_filter_status(){
        $('#filter-status').slideUp()
    }

            // -- end subpage init

            $(document).ready(function(){
                /* Run when the document is ready
                */
                highlight_syntax()

                // Subpage doc ready --
                

    // Highlight the 'blog' menu item
    menu_highlight('blog');

    // Filter by tag on load if necessary
    var filter_on_hash = function(){
        if(window.location.hash){
            filter_by_tag(window.location.hash.slice(1));
        }
    }();

    // When a tag link is clicked...
    $('.tag-link').click(function(){
        /* When the user clicks on a tag link, filter blog articles by the
        specified tag and activate the link's list item.
        */
        filter_by_tag($(this).attr('tag'))
    });

    // When a 'clear filter' link is clicked...
    $('a.clear-filter').click(function(){
        /* When the user clicks on a 'clear filter' link, show all blog
        articles, and deactivate any filter links.
        */

        show_all();
        deactivate_all_filter_links();
        hide_filter_status();
    })

                // -- end subpage doc ready
            });
        </script>
    </body>
</html>